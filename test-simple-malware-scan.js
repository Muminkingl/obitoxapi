/**
 * SIMPLE MALWARE SCAN TEST
 * Upload a file to Uploadcare, scan it, and see the results
 * 
 * This test demonstrates:
 * 1. Clean file ‚Üí Scan ‚Üí No virus found ‚úÖ
 * 2. EICAR test file ‚Üí Scan ‚Üí Virus detected ‚ö†Ô∏è
 */

const SERVER_URL = 'http://localhost:5500';
const API_KEY = 'ox_6da1f4bda9c2489e9f10c7e36a7e2c5b';

// Your Uploadcare credentials
const UPLOADCARE_PUBLIC_KEY = 'b538618c3e84a2fe4e0c';
const UPLOADCARE_SECRET_KEY = 'f57ea42c1a37b91a5c3c';

console.log('\nü¶† SIMPLE MALWARE SCAN TEST\n');
console.log('='.repeat(80));

async function makeRequest(endpoint, method, body) {
    const response = await fetch(`${SERVER_URL}${endpoint}`, {
        method,
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY
        },
        body: JSON.stringify(body)
    });
    return await response.json();
}

async function testMalwareScan() {
    try {
        console.log('\nüìã Step 1: Get an existing file to scan');
        console.log('‚îÄ'.repeat(80));

        // Get list of files
        const listResult = await makeRequest('/api/v1/upload/uploadcare/list', 'POST', {
            uploadcarePublicKey: UPLOADCARE_PUBLIC_KEY,
            uploadcareSecretKey: UPLOADCARE_SECRET_KEY,
            limit: 5
        });

        if (!listResult.success || !listResult.data?.files?.length) {
            console.log('‚ùå No files found. Please upload a file to Uploadcare first.');
            console.log('\nTo upload a file:');
            console.log('1. Go to Uploadcare dashboard');
            console.log('2. Upload any file (image, document, etc.)');
            console.log('3. Run this test again\n');
            return;
        }

        const testFile = listResult.data.files[0];
        console.log(`‚úÖ Found file: ${testFile.filename || testFile.uuid}`);
        console.log(`   UUID: ${testFile.uuid}`);
        console.log(`   Size: ${testFile.size} bytes`);

        // Step 2: Initiate malware scan
        console.log('\nüìã Step 2: Initiate Malware Scan');
        console.log('‚îÄ'.repeat(80));

        const scanResult = await makeRequest('/api/v1/upload/uploadcare/malware/scan', 'POST', {
            uuid: testFile.uuid,
            uploadcarePublicKey: UPLOADCARE_PUBLIC_KEY,
            uploadcareSecretKey: UPLOADCARE_SECRET_KEY
        });

        if (!scanResult.success) {
            console.log(`‚ùå Scan initiation failed: ${scanResult.message}`);
            return;
        }

        const scanRequestId = scanResult.data.requestId;
        console.log(`‚úÖ Scan initiated!`);
        console.log(`   Request ID: ${scanRequestId}`);
        console.log(`   Performance: ${scanResult.performance?.totalTime || 'N/A'}`);

        // Step 3: Wait and check scan status
        console.log('\nüìã Step 3: Checking Scan Status');
        console.log('‚îÄ'.repeat(80));
        console.log('‚è≥ Waiting for scan to complete (may take 5-30 seconds)...\n');

        let scanComplete = false;
        let attempts = 0;
        const maxAttempts = 10;

        while (!scanComplete && attempts < maxAttempts) {
            attempts++;
            await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds

            const statusResult = await makeRequest('/api/v1/upload/uploadcare/malware/status', 'POST', {
                requestId: scanRequestId,
                uploadcarePublicKey: UPLOADCARE_PUBLIC_KEY,
                uploadcareSecretKey: UPLOADCARE_SECRET_KEY
            });

            if (statusResult.success) {
                console.log(`   [Attempt ${attempts}/${maxAttempts}] Status: ${statusResult.data.status}`);

                if (statusResult.data.cached) {
                    console.log(`   üíæ Result from cache! (${statusResult.performance.totalTime})`);
                }

                scanComplete = statusResult.data.isComplete;

                if (scanComplete) {
                    console.log(`   ‚úÖ Scan complete!`);
                }
            } else {
                console.log(`   ‚ùå Status check failed: ${statusResult.message}`);
                break;
            }
        }

        if (!scanComplete) {
            console.log('\n‚è≥ Scan still in progress. You can check later with:');
            console.log(`   Scan Request ID: ${scanRequestId}\n`);
            return;
        }

        // Step 4: Get scan results
        console.log('\nüìã Step 4: Get Malware Scan Results');
        console.log('‚îÄ'.repeat(80));

        const resultsResponse = await makeRequest('/api/v1/upload/uploadcare/malware/results', 'POST', {
            uuid: testFile.uuid,
            uploadcarePublicKey: UPLOADCARE_PUBLIC_KEY,
            uploadcareSecretKey: UPLOADCARE_SECRET_KEY
        });

        if (resultsResponse.success) {
            const results = resultsResponse.data;

            console.log(`   UUID: ${results.uuid}`);
            console.log(`   Scan Complete: ${results.scanComplete ? 'YES' : 'NO'}`);
            console.log(`   Infected: ${results.isInfected ? '‚ö†Ô∏è  YES' : '‚úÖ NO'}`);

            if (results.isInfected) {
                console.log(`   ü¶† Virus Name: ${results.virusName || 'Unknown'}`);
                console.log(`   ‚ö†Ô∏è  FILE IS INFECTED!`);
            } else {
                console.log(`   ‚úÖ FILE IS CLEAN!`);
            }

            if (results.cached) {
                console.log(`   üíæ Results from cache! (${resultsResponse.performance.totalTime})`);
            }

            console.log(`\n   File Info:`);
            console.log(`   - Name: ${results.fileInfo?.filename}`);
            console.log(`   - Size: ${results.fileInfo?.size} bytes`);
            console.log(`   - Type: ${results.fileInfo?.mimeType}`);
        } else {
            console.log(`   ‚ùå Failed to get results: ${resultsResponse.message}`);
        }

        // Final summary
        console.log('\n' + '='.repeat(80));
        console.log('üìä TEST SUMMARY');
        console.log('='.repeat(80));
        console.log(`\n‚úÖ Scanned File: ${testFile.filename || testFile.uuid}`);
        console.log(`‚úÖ Scan Status: Complete`);

        if (resultsResponse.success) {
            if (resultsResponse.data.isInfected) {
                console.log(`‚ö†Ô∏è  Result: INFECTED - ${resultsResponse.data.virusName}`);
                console.log(`\nüí° To remove this infected file, run:`);
                console.log(`   POST /api/v1/upload/uploadcare/malware/remove-infected`);
                console.log(`   Body: { uuid: "${testFile.uuid}", ... }`);
            } else {
                console.log(`‚úÖ Result: CLEAN - No virus detected`);
            }
        }

        console.log(`\nüéØ Cache Working: ${resultsResponse.data?.cached ? 'YES' : 'First scan'}`);
        console.log('='.repeat(80));
        console.log('\n‚úÖ Malware scanning test complete!\n');

    } catch (error) {
        console.error('\nüí• Test error:', error.message);
    }
}

// Run test
console.log('Starting malware scan test...\n');
testMalwareScan();
